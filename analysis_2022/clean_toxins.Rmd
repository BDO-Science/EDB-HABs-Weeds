---
title: "clean_toxins"
author: "Catarina Pien"
date: '2022-10-03'
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Packages
```{r}
library(tidyverse)
library(lubridate)
library(sf)
library(readxl)
#library(DroughtData)
library(RColorBrewer)
library(deltamapr)
library(ggmap)
library(ggsn)

library(here)

root <- "analysis_2022/" # this is to tell here where to start
```

Color palette
```{r}
HABcol = data.frame(Color = brewer.pal(7, "Dark2"),
                    Genus = c( "Anabaenopsis", "Aphanizomenon","Cylindrospermopsis", "Dolichospermum" ,
                               "Microcystis","Oscillatoria","Planktothrix"))
```

**Data Sources: **

* DWR - SWP
* Water Board - fHAB Stockton Waterfront Labor Day
* EB Parks - Big Break
* Water Board/Nautilus - Stockton
* Prop 1 water samples
* USGS Water Samples
* USGS Spatt

# Read in files 
```{r}
ct_swp0 <- read_excel(here(root, "data_raw", "DFD_SWP_cyano_data_2022.xlsx"))
site_swp <- read_excel(here(root, "data_raw", "DWR_SWP_Cyanotoxin_results_2022.xlsx"), sheet = "Sample Location Info") %>%
  janitor::clean_names(case = "big_camel") %>%
  rename(Site_Name = Name)
ct_wb0 <- read_csv(here(root, "data_raw", "SWB_fHAB_cyano_2022.csv")) %>%
  filter(!is.na(Result)) # data originally in pdf and imported into csv
ct_eb0 <- read_excel(here(root, "data_raw", "EBParks_BigBreak_Cyanotoxin_2022.xlsx"), skip = 1) %>%
  filter(!is.na(Park))
# Note: Danger Advisory posted 7/14/22
ct_naut0 = read_excel(here(root, "data_raw", "Nautilus_HAB_Chlorophyll_2022.xlsx"))
ct_usgs0 <- read_tsv(here(root, "data_raw", "USGS_cyanotoxins_WW.tsv"))
site_usgs0 <- read_tsv(here(root, "data_raw", "USGS_cyanotoxins_SiteLatLon.tsv"))
```

```{r}
spatt_files_DSP <- list.files("analysis_2022/data_raw", pattern = "USGS_Spatt_DSP", full.names = TRUE)
spatt1 <- lapply(spatt_files_DSP, read_excel, sheet = "Total Toxin Summary") %>%
  bind_rows() %>%
  janitor::clean_names(case = "upper_camel") %>%
  rename(TotalAnabaenopeptinsPpb = TotalAnabaenopetinsPpb,
         TotalAnabaenopeptinsNgG = TotalAnabaenopetinsNgG) %>%
  mutate(across(TotalMicrocystinsPpb:TotalOtherToxinsNgG, ~ replace(., str_detect(., 'ND'), 0)),
         across(TotalMicrocystinsPpb:TotalOtherToxinsNgG, as.numeric))

spatt2 <- lapply(spatt_files_MDM, read_excel, sheet = "Total Toxin Summary") %>%
  bind_rows() %>%
  janitor::clean_names(case = "upper_camel") %>%
  rename(TotalAnabaenopeptinsPpb = TotalAnabaenopetinsPpb,
         TotalAnabaenopeptinsNgG = TotalAnabaenopetinsNgG) %>%
  select(VialNumber, ProjectUniqueId, FieldId, StationNumber, SampleStartDate, SampleStartTimePst,
         TotalMicrocystinsPpb, TotalAnabaenopeptinsPpb, TotalAnatoxinsPpb, TotalCylindrospermopsinsPpb, TotalSaxitoxinsPpb, TotalOtherToxinsPpb, TotalMicrocystinsNgG, TotalAnabaenopeptinsNgG, TotalAnatoxinsNgG, TotalCylindrospermopsinsNgG, TotalSaxitoxinsNgG, TotalOtherToxinsNgG)%>%
  mutate(across(TotalMicrocystinsPpb:TotalOtherToxinsNgG, ~ replace(., str_detect(., 'ND'), 0)),
         across(TotalMicrocystinsPpb:TotalOtherToxinsNgG, as.numeric))

spatt = rbind(spatt1, spatt2)
```

# Format

## SWP
There is some method information in the DWR_SWP_cyano_data_2022.xlsx file that can be extracted if needed.

Had to estimate Latitude and Longitude for Lake Del Valle, Barker Slough PP, Banks PP
```{r}
#Get the species into a consistent format
unique(ct_swp0$`PTOX Species 1`)
ct_swp = ct_swp0 %>%
  mutate(Species = case_when(
  `PTOX Species 1` %in% c("Aphanizomenon cf. flos-aquae/klebahnii",
                        "Aphanizomenon flos-aquae/klebahnii", "cf. Aphanizomenon") ~ "Aphanizomenon",
  `PTOX Species 1` %in% c("Oscillatoria cf. perornata", "Oscillatorialean filament(s)") ~ "Oscillatoria",
  `PTOX Species 1` %in% c("cf. Phormidium", "Phormidium/Microcoleus") ~ "Phormidium",
  `PTOX Species 1` == "cf. Planktothrix" ~ "Planktothrix",
  TRUE ~ `PTOX Species 1`
), Concentration = parse_number(`Result (ng/mL)`))

#Now pivot wider then longer so I can add in zeros
swp = pivot_wider(ct_swp, id_cols = c(Station, Date, Notes), names_from = Species,
                       values_from = Concentration, values_fill = 0, values_fn = sum) %>%
  dplyr::select(!`none observed`) %>%
  pivot_longer(cols = Dolichospermum:`Microcystis wesenbergii`, names_to = "Species") %>%
  filter(!is.na(value)) %>%
  
  mutate(SampleID = paste0(Date, Station),
         Site_Name = case_when(Station == "NBA Barker Sl PP" ~ "Barker Slough Pumping Plant",
                                  Station == "Banks PP" ~ "Banks Pumping Plant",
                                  Station == "Clifton Court Forebay"~"Clifton Court Forebay Inlet",
                                  Station == "Dyer Res Outlet" ~ "Dyer Reservoir Outlet",
                                  grepl("Lake Del Valle", Station) ~ "Lake Del Valle",
                                  TRUE ~ Station),
         Method = NA,
         Comments = Notes) %>%
  left_join(site_swp %>% select(Site_Name, ApproximateGpsCoordinates, SampleLocation)) %>%
  separate(ApproximateGpsCoordinates, c("Latitude", "Longitude"), sep = ",") %>%
  mutate(Latitude = case_when(Station == "NBA Barker Sl PP" ~ 38.275900,
                              Station == "Banks PP" ~ 37.801944,
                              Site_Name == "Lake Del Valle" ~ 37.586130,
                              TRUE ~ as.numeric(Latitude)),
         Longitude = case_when(Station == "NBA Barker Sl PP" ~ -121.7965,
                              Station == "Banks PP" ~ -121.620278,
                              Site_Name == "Lake Del Valle" ~ -121.703795,
                              TRUE ~ as.numeric(Longitude)),
         Date = date(Date),
         Study = "SWP")%>%
  dplyr::select(SampleID, Station_Code = Station, Site_Name , Latitude, Longitude, Method, Analyte=Species, Result = value, Comments, SampleDate = Date, Study)


glimpse(swp)

#quick plot
ggplot(swp, aes(x = as.factor(SampleDate), y = Result, fill = Analyte)) + geom_bar(stat = "identity")
```

## Water Board
```{r}

# Add lat/lon based on COC_20220824.pdf
wb <- ct_wb0 %>%
  mutate(Latitude = case_when(Station == "Buckley Cove" ~ 37.97717,
                              Station == "SJR @ Stockton GC" ~ 37.95416,
                              Station == "McLeod Lake" ~ 37.9536),
         Longitude = case_when(Station == "Buckley Cove" ~ -121.37543,
                              Station == "SJR @ Stockton GC" ~ -121.34397,
                              Station == "McLeod Lake" ~ -121.293),
         Station_Code = case_when(Station == "Buckley Cove" ~ "Buckley",
                              Station == "SJR @ Stockton GC" ~ "SJR_StocktonGC",
                              Station == "McLeod Lake" ~ "McLeadLake"),
         Result = ifelse(Result == "ND", 0, Result),
         Result = as.numeric(Result),
         Comments = "NA",
         Datetime = mdy_hm(Datetime),
         Date = date(Datetime),
         SampleID = paste0(Datetime, Station_Code),
         Study = "fHAB") %>%
  dplyr::select(SampleID, Station_Code, Site_Name = Station, Latitude, Longitude, Method, Analyte=Target, Result, Comments, SampleDate = Date, Study)
```


## EB Parks

* Used lat/lon from old data
* Used some of the naming from old data
* Unfortunately lots of dates with no actual data. Left comments in in case we can use that in the text to indicate there was probably Microcystis.

```{r}
ebparks = ct_eb0 %>%
  mutate(Station_Code = "07BBkayaklaun",
         Latitude = 38.01245,
         Longitude = -121.7282,
         Date = as.Date(as.numeric(Date), origin = "1899-12-30"))%>%
  mutate(Result = case_when(`Toxin Result (ppb)` == "ND" ~ 0,
                            `Toxin Result (ppb)` == " > 50" ~ 50,
                            `Toxin Result (ppb)` == "0.01 ppb" ~ 0.01,
                            `Toxin Result (ppb)` == "> 10 ppb" ~ 10,
                            TRUE ~ as.numeric(`Toxin Result (ppb)`)),
         SampleID = paste0(Date, Site),
         Method = NA,
         Analyte = "Microcystins", Station = "BigBreak",
         Study = "Parks") %>%
  select(SampleID, Station_Code, Site_Name = Site, Latitude, Longitude, Method, Analyte, Result, Comments = Commments, SampleDate = Date, Study)
```

## Nautilus
```{r}
naut = ct_naut0 %>%
  janitor::clean_names(case = "upper_camel") %>%
  mutate(SampleID = paste0(SampleDate, SampleTime, Location),
         Site_Name = NA, Comments = NA,
         Study = "Nautilus") %>%
  dplyr::select(SampleID, Station_Code = Location, Site_Name, Latitude, Longitude, Method, Analyte = Parameter, Result, Comments, SampleDate, Study) %>%
  mutate(Result = case_when(Result == "ND" ~ 0,
                            TRUE ~ as.numeric(Result))) %>%
  dplyr::filter(!is.na(Result))
```

## USGS
Lat/Lon is NAD83

need info on SJMS
```{r}
usgs <- ct_usgs0 %>%
  mutate(Comments = NA,
         Resultf = case_when(Result == "ND" ~ "0",
                             Result == "N/A" ~ "NA",
                            TRUE ~ as.character(Result)),
         Result = as.numeric(Resultf),
         Study = "USGS") %>%
  #filter(detect_tox == "Yes") %>%
left_join(site_usgs0 %>% select(NWIS_site_no, Site, dec_lat_va, dec_long_va)) %>%
  dplyr::select(SampleID = UniqueID, Station_Code = NWIS_site_no, Site_Name = Site, Latitude = dec_lat_va, Longitude = dec_long_va, Method, Analyte, Result, Comments, SampleDate = Date, Study)
```

## Spatt - not currently included
Why are there different units?
```{r}
ggplot(spatt) + geom_point(aes(SampleStartDate, TotalMicrocystinsPpb, color = FieldId)) +
  theme_bw()
ggplot(spatt) + geom_point(aes(SampleStartDate, TotalAnatoxinsNgG, color = FieldId)) + theme_bw()
```

# Combine data

* SWP, Spatt, Stockton, Prop1, Nautilus, EastBay

```{r}
ct_all <- rbind(swp, wb, ebparks, naut, usgs) %>%
  mutate(Analyte2 = case_when(grepl("MC",Analyte) |grepl("Microcys", Analyte) | grepl("D-Asp3-", Analyte)|grepl("Leu1", Analyte)|grepl("Dha-LR", Analyte) ~ "Microcystins",
                              grepl("Anatoxin", Analyte) ~ "Anatoxins",
                              grepl("Dolicho", Analyte) ~ "Dolichopspermum",
                              grepl("Anabaen", Analyte)|grepl("Oscillamide", Analyte) ~ "Anabaenopeptin",
                              grepl("Cylindrospermopsin", Analyte) ~ "Cylindrospermopsin",
                             TRUE ~ Analyte),
         Longitude = ifelse(Longitude>0, Longitude * -1, Longitude)) %>%
         filter(!is.na(Result))

glimpse(ct_all)
unique(ct_all$Analyte2)
```

# Add warnings
```{r}
ct_all2 = ct_all %>%
  filter(Analyte2 %in% c("Microcystins", "Anatoxins")) %>%
  mutateAdvisory = case_when(Analyte2 == "Microcystins" & Result > 0.8 & Result < 6 ~ "Caution",
                                                 Analyte2 == "Microcystins"  & Result >= 6 & Result < 20 ~ "Warning",
                                                 Analyte2 == "Microcystins"  & Result >= 20 ~ "Danger",
                                                 Analyte2 == "Microcystins"  & Result < 0.8 ~ "No Advisory",
                                               Analyte2 == "Anatoxins" & Result > 20 & Result <90 ~ "Warning",
                                               Analyte2 == "Anatoxins"  & Result > 0 & Result < 20 ~ "Caution",
                                               Analyte2 == "Anatoxins"  & Result == 0 ~ "No Advisory")
```

# Add geometry
```{r}
ct_all_sf <- ct_all2 %>%
  filter(!is.na(Latitude)) %>%
  st_as_sf(coords =c("Longitude", "Latitude"), remove = FALSE)
st_crs(ct_all_sf) <- 4269
```

```{r}
mapview::mapview(ct_all_sf)
```

```{r}
write_csv(ct_all_sf, "data_clean/ct_all_2022.csv")
```


# Add warning levels 

```{r}
ct_all2 = ct_all %>%
  filter(Analyte2 %in% c("Microcystins", "Anatoxins")) %>%
  mutateAdvisory = case_when(Analyte2 == "Microcystins" & Result > 0.8 & Result < 6 ~ "Caution",
                                                 Analyte2 == "Microcystins"  & Result >= 6 & Result < 20 ~ "Warning",
                                                 Analyte2 == "Microcystins"  & Result >= 20 ~ "Danger",
                                                 Analyte2 == "Microcystins"  & Result < 0.8 ~ "No Advisory",
                                               Analyte2 == "Anatoxins" & Result > 20 & Result <90 ~ "Warning",
                                               Analyte2 == "Anatoxins"  & Result > 0 & Result < 20 ~ "Caution",
                                               Analyte2 == "Anatoxins"  & Result == 0 ~ "No Advisory")
```


# Filter only Microcystins and Anatoxins 
```{r}
#To plot the toxin data, I want to put it in terms of the health
#advisory levels from OEHHA. Here is a dataframe of those levels:
health = data.frame(Analyte = c("Microcystins", "Microcystins", "Microcystins", "Anatoxins","Anatoxins"), Advisory = c(0.8, 6,20, .5, 20),
                    AdviseType = c("Caution\nTier I", "Warning \nTier II","Danger \nTier III", "Caution\nTier I", "Warning \nTier II")) %>%
  mutate(AdviseType = factor(AdviseType, levels = c("Caution\nTier I", "Warning \nTier II","Danger \nTier III")))
```












# Combine with last year's dataset 

```{r}
ct_2021 <- read.csv(here("data", "Alltoxindata.csv")) %>%
  select(-1)

glimpse(ct_2021)
```



# Write data
```{r}

```

