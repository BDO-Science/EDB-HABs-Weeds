---
title: "map_stations"
author: "Catarina Pien"
date: '2022-10-24'
output: html_document
editor_options: 
  chunk_output_type: console
---

# In this code we make the following maps:

1) Continuous WQ
2) Continuous WQ + Discrete WQ (Nutrients and Physical)
3) Phytoplankton (EMP) + Microcystis Visual Index

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(lubridate) #today()
library(readr)
library(here)
library(Polychrome)
library(viridis)
library(deltamapr)
library(sf)
library(ggspatial)
library(readxl)

data_root = "analysis_2022/"
```

# Regions Data
```{r}

load("./data/Regions.RData")
reg3crop = st_crop(reg3, xmin = -121.9, xmax = -121.2, ymin = 37.65, ymax = 38.4)

```

# Water Quality
```{r}
sta_cont <- read_excel(here(data_root, "data_clean", "continuous_stations.xlsx")) %>%
  filter(Type == "WQ") %>%
  dplyr::select(-Type) %>%
  rename(Station = StationCode) %>%
  mutate(WQ = "Continuous") %>%
  mutate(Source = case_when(
    Station == "FRK" ~ "DWR_EMP",
    Station %in% c("MDM", "ORQ", "DSJ") ~ "USGS_CAWSC",
    TRUE ~ "DWR_NCRO"
  ))

sta_discrete <- read_csv(here(data_root, "data_clean", "discrete_wq_stations_all_2022.csv")) %>%
  mutate(WQ = "Discrete")

habsnuts <-  read_csv("analysis_2022/data_clean/HABs_FinalNuts.csv") %>%
  select(Source, Station, Latitude, Longitude) %>%
  distinct() %>%
  mutate(WQ = "Nutrients")

# The ones that don't join are just named the same. Just ignore the nutrients then. 
anti_join(habsnuts, sta_discrete, by = c("Source", "Station"))
anti_join(sta_discrete, habsnuts, by = c("Source", "Station"))

sta_combined <- bind_rows(sta_cont, sta_discrete) %>%
  filter(!is.na(Latitude))

sta_sf <- st_as_sf(sta_combined, coords = c("Longitude", "Latitude"), crs = 4326, remove = FALSE) %>%
  filter(Longitude > -121.85)

delta_4326 <- st_transform(WW_Delta, crs = st_crs(sta_sf))

```

## Make map of regions
```{r}
(regions_map <- ggplot() + 
  geom_sf(data = delta_4326, fill = "lightblue", color = "lightblue") +
  geom_sf(data = reg3, aes(fill = Stratum2), inherit.aes = FALSE, alpha = 0.3)+
  geom_sf_label(data = reg3crop, aes(label = Stratum2), size = 3.8,
               nudge_y = c(0.1, 0.05, 0, 0, 0, 0, -0.01, 0),
               nudge_x = c(-0.05, 0.05, -0.08, 0.07, 0.09, 0.1, 0, -0.01))+
  scale_fill_manual(values = reg3crop$colors, name = NULL, guide = NULL)+
  scale_color_manual(values = c("mediumblue", "sienna3")) +
  scale_x_continuous(limits = c(-122, -121.2)) +
  scale_y_continuous(limits = c(37.7, 38.6))+
  labs(fill = "Region") + 
  annotation_north_arrow(location = "tr", which_north = "true",
                             pad_x = unit(.1, "in"), pad_y = unit(0.2, "in"),
                             style = north_arrow_fancy_orienteering) +
      annotation_scale(location = "bl", bar_cols = c("black", "white", "black", "white")) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, vjust = 0.5)))
```

```{r}
png(filename = here("analysis_2022", "figures", "map_regions.png"), width = 6, height = 7, units = "in", pointsize = 12, family = "sans", res = 300)
regions_map
dev.off()
```



## Map of stations
### Continuous
```{r}
cont <- sta_sf %>%filter(WQ == "Continuous") %>%
  mutate(Location = ifelse(Station %in% c("DSJ", "BLP"), "Big Break", "Frank's Tract"))


(cont_map <- ggplot() + 
  geom_sf(data = delta_4326, fill = "lightblue", color = "lightblue") +
  geom_sf(data = reg3, aes(fill = Stratum2), inherit.aes = FALSE, alpha = 0.3)+
  geom_sf(data = cont, aes(color = Location), inherit.aes = FALSE)+
  geom_text(data = cont, aes(x = Longitude, y = Latitude, label = Station), size = 3, vjust = 1, hjust = 1)+
  scale_fill_manual(values = reg3crop$colors, name = NULL, guide = NULL)+
  scale_color_manual(values = c("mediumblue", "sienna3")) +
  scale_x_continuous(limits = c(-121.8, -121.4)) +
  scale_y_continuous( limits = c(37.9, 38.15))+
  labs(fill = "Region") + 
  annotation_north_arrow(location = "tr", which_north = "true",
                             pad_x = unit(.1, "in"), pad_y = unit(0.2, "in"),
                             style = north_arrow_fancy_orienteering) +
      annotation_scale(location = "bl", bar_cols = c("black", "white", "black", "white")) +
  theme_bw())
```

### Discrete and Continuous
```{r}
(wq_map <- ggplot() + 
  geom_sf(data = delta_4326, fill = "lightblue", color = "lightblue") +
  geom_sf(data = reg3, aes(fill = Stratum2), inherit.aes = FALSE, alpha = 0.3)+
  geom_sf(data = sta_sf, aes(color = WQ, shape = Source), inherit.aes = FALSE)+
   # geom_text(data = stations, aes(x = Longitude, y = Latitude, label = Site), size = 3, vjust = 1, hjust = 1)+
  scale_x_continuous(limits = c(-122, -121.2)) +
  scale_y_continuous( limits = c(37.7, 38.6))+
  scale_fill_manual(values = reg3crop$colors, name = NULL, guide = NULL)+
  scale_shape_manual(values = c(21, 8,25)) + 
  labs(fill = "Region") + 
  annotation_north_arrow(location = "tr", which_north = "true",
                             pad_x = unit(.1, "in"), pad_y = unit(0.2, "in"),
                             style = north_arrow_fancy_orienteering) +
      annotation_scale(location = "bl", bar_cols = c("black", "white", "black", "white")) +
   scale_color_manual(values = c("red","blue4")) + 
  theme_bw())
```

## Write

```{r}
png(filename = here("analysis_2022", "figures", "map_wq.png"), width = 6, height = 7, units = "in", pointsize = 12, family = "sans", res = 300)
wq_map
dev.off()

png(filename = here("analysis_2022", "figures", "map_cont_wq.png"), width = 6, height = 6, units = "in", pointsize = 12, family = "sans", res = 300)
cont_map
dev.off()
```

# Phytoplankton and Microcystis Visual Index

## Process
```{r}
phytodata <- readRDS("analysis_2022/data_clean/emp_phyto_data_through2022.rds") %>% 
  extract(geometry, into = c("Longitude", "Latitude"), '\\((.*),(.*)\\)', conv = T) %>%
  dplyr::select(Station, Longitude, Latitude) %>%
  st_drop_geometry() %>%
  distinct() %>%
  mutate(Source = "EMP",
         Data = "Phytoplankton")

load(here("analysis_2022", "data_clean", "HABSw2022.RData"))

micdata <- HABs2022 %>%
  select(Source, Station, Latitude, Longitude) %>%
  distinct() %>%
  mutate(Data = "Microcystis Index") %>%
  filter(Source !="DOP")

phyto_combined <- rbind(micdata, phytodata)  %>%
  filter(!is.na(Latitude)) %>%
  distinct() %>%
  st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326) %>%
  st_intersection(reg3) # This part ensures we only capture those that are in strata

```

## Map

```{r}
(map_phyto_micro <- ggplot()+
  geom_sf(data = delta_4326, fill = "lightblue", color = "lightblue") +
  geom_sf(data =reg3, aes(fill = Stratum2), inherit.aes = FALSE, alpha = 0.3)+
  geom_sf(data =phyto_combined, aes(shape = Source, color = Data, size = Data), inherit.aes = FALSE,alpha = 0.8)+
  scale_color_manual(values= c("black", "red"))+
  scale_fill_manual(values = reg3crop$colors, name = NULL, guide = NULL)+
  theme_bw()+
  scale_x_continuous(limits = c(-121.9, -121.2)) +
  scale_y_continuous( limits = c(37.65, 38.6))+
  scale_size_manual(values= c(1,3)) +
  annotate("text", x = -121.3, y = 37.7, label = "Vernalis")+
  annotate("text", x = -121.6, y = 37.77, label = "Clifton Court")+
  annotation_north_arrow(location = "tr", which_north = "true",
                             pad_x = unit(.1, "in"), pad_y = unit(0.2, "in"),
                             style = north_arrow_fancy_orienteering) +
      annotation_scale(location = "bl", bar_cols = c("black", "white", "black", "white"))  +
  labs(fill = "Region") + 
  theme(legend.position = "right",
        #legend.direction = "horizontal",
        #legend.box = "vertical",
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 45, vjust = 0.5)))
```

```{r}
png(filename = here("analysis_2022", "figures", "map_phytoplankton_microcystis.png"), width = 6, height = 7, units = "in", pointsize = 12, family = "sans", res = 300)
map_phyto_micro
dev.off()
```


# Tables
2-5 Station Code - Operator - USGS Station ID - Station Name - Latitude - Longitude - Sensors
```{r}

```
